import{x as J,w as P,a as U,r as p,p as m,aa as b,j as t,az as z,a2 as I,b8 as G,aw as V,H as N,d as X,y as q,b9 as K,aV as Q,b0 as Y}from"./index-B7WG_kHJ-1769026461592.js";import{d as Z,L as F}from"./Layout-BnB1agDJ-1769026461592.js";import{m as y}from"./motion-DSM7Rpg2-1769026461592.js";import"./index-yirOBEcN-1769026461592.js";import"./useTranslation-CnXjuBvM-1769026461592.js";import"./responsive-BJrBEfWo-1769026461592.js";import"./omniapiApi-DDnppdd_-1769026461592.js";function _(d){const u=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(d);return u?`${parseInt(u[1],16)}, ${parseInt(u[2],16)}, ${parseInt(u[3],16)}`:"106, 212, 160"}const se=()=>{const{colors:d,modeColors:u}=J(),{impiantoCorrente:i}=P(),{user:n}=U(),{resetUnreadCount:j,decrementUnreadCount:$}=Z(),[A,f]=p.useState([]),[S,x]=p.useState(0),[T,w]=p.useState(!0),[c,M]=p.useState("all"),r={...u,accent:d.accent,accentLight:d.accentLight,accentDark:d.accentDark,border:`rgba(${_(d.accent)}, 0.15)`,borderHover:`rgba(${_(d.accent)}, 0.35)`},D={background:r.bgCardLit,border:`1px solid ${r.border}`,borderRadius:"16px",boxShadow:r.cardShadowLit,position:"relative",overflow:"hidden"},v=p.useCallback(async()=>{if(!(i!=null&&i.id)){w(!1),f([]);return}w(!0);try{const{data:e}=await m.get(`/api/notifications/history?impiantoId=${i.id}&limit=100`),a=(e==null?void 0:e.notifications)||[];f(Array.isArray(a)?a:[]),x(typeof(e==null?void 0:e.unreadCount)=="number"?e.unreadCount:0)}catch(e){console.error("Error loading notifications:",e),f([]),x(0)}finally{w(!1)}},[i==null?void 0:i.id]),g=p.useRef(null);p.useEffect(()=>{var o;(async()=>{if(await v(),i!=null&&i.id)try{await m.post("/api/notifications/read-all",{impiantoId:i.id}),x(0),j()}catch(s){console.error("Error auto-marking as read:",s)}})(),i!=null&&i.id&&b.joinImpianto(i.id);const a=s=>{f(l=>l.some(h=>h.id===s.id)?l:[s,...l]),x(l=>l+1)};return g.current=a,(o=b.getSocket())==null||o.on("notification",a),()=>{var s;i!=null&&i.id&&b.leaveImpianto(i.id),g.current&&((s=b.getSocket())==null||s.off("notification",g.current),g.current=null)}},[v,i==null?void 0:i.id,j]);const k=e=>{if(!e)return[];if(Array.isArray(e))return e;if(typeof e=="string")try{const a=JSON.parse(e);return Array.isArray(a)?a:[]}catch{return[]}return[]},R=e=>n!=null&&n.id?k(e.read_by).includes(n.id):!1,B=async e=>{try{await m.post(`/api/notifications/${e}/read`),f(a=>a.map(o=>{if(o.id===e&&(n!=null&&n.id)){const s=k(o.read_by);if(!s.includes(n.id))return{...o,read_by:JSON.stringify([...s,n.id])}}return o})),x(a=>Math.max(0,a-1)),$()}catch(a){console.error("Error marking as read:",a)}},E=async()=>{if(i!=null&&i.id)try{await m.post("/api/notifications/read-all",{impiantoId:i.id}),f(e=>e.map(a=>{if(n!=null&&n.id){const o=k(a.read_by);if(!o.includes(n.id))return{...a,read_by:JSON.stringify([...o,n.id])}}return a})),x(0),j(),N.success("Tutte le notifiche segnate come lette")}catch(e){console.error("Error marking all as read:",e),N.error("Errore")}},W=e=>{switch(e){case"gateway_offline":case"device_offline":return t.jsx(Y,{size:22,color:r.error});case"gateway_online":case"device_online":return t.jsx(Q,{size:22,color:r.success});case"scene_executed":return t.jsx(K,{size:22,color:r.info});case"relay_changed":return t.jsx(q,{size:22,color:r.warning});case"system":return t.jsx(X,{size:22,color:r.warning});default:return t.jsx(z,{size:22,color:r.accent})}},L=A.filter(e=>c==="all"?!0:c==="unread"?!R(e):e.type===c||e.type.startsWith(c.replace("_offline","").replace("_online",""))),O=e=>{const a=new Date(e),s=new Date().getTime()-a.getTime(),l=Math.floor(s/6e4),h=Math.floor(s/36e5),C=Math.floor(s/864e5);return l<1?"Ora":l<60?`${l} min fa`:h<24?`${h} ore fa`:C<7?`${C} giorni fa`:a.toLocaleDateString("it-IT",{day:"2-digit",month:"short"})},H=[{value:"all",label:"Tutte"},{value:"unread",label:"Non lette"},{value:"gateway",label:"Gateway"},{value:"scene_executed",label:"Scene"},{value:"device",label:"Dispositivi"}];return t.jsx(F,{children:t.jsxs(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},style:{padding:"16px",paddingBottom:"100px"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"24px"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[t.jsx(z,{size:28,color:r.accent}),t.jsx("h1",{style:{fontSize:"24px",fontWeight:"bold",color:r.textPrimary,margin:0},children:"Notifiche"}),S>0&&t.jsx("span",{style:{padding:"4px 10px",fontSize:"12px",fontWeight:"bold",borderRadius:"12px",color:"white",backgroundColor:r.accent},children:S})]}),t.jsxs("div",{style:{display:"flex",gap:"8px"},children:[t.jsx(y.button,{whileTap:{scale:.95},onClick:v,style:{padding:"10px",borderRadius:"12px",background:r.bgCard,border:`1px solid ${r.border}`,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(I,{size:20,color:r.textSecondary})}),S>0&&t.jsx(y.button,{whileTap:{scale:.95},onClick:E,style:{padding:"10px",borderRadius:"12px",background:r.bgCard,border:`1px solid ${r.border}`,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},title:"Segna tutte come lette",children:t.jsx(G,{size:20,color:r.accent})})]})]}),t.jsx("div",{style:{display:"flex",gap:"8px",marginBottom:"16px",overflowX:"auto",paddingBottom:"8px"},children:H.map(e=>t.jsx(y.button,{whileTap:{scale:.95},onClick:()=>M(e.value),style:{padding:"8px 16px",borderRadius:"20px",fontSize:"14px",whiteSpace:"nowrap",cursor:"pointer",backgroundColor:c===e.value?r.accent:r.bgCard,color:c===e.value?"white":r.textSecondary,border:`1px solid ${c===e.value?r.accent:r.border}`,fontWeight:c===e.value?"600":"400"},children:e.label},e.value))}),T?t.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"48px 0"},children:t.jsx(y.div,{animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"},children:t.jsx(I,{size:32,color:r.accent})})}):L.length===0?t.jsxs("div",{style:{textAlign:"center",padding:"48px 0"},children:[t.jsx(z,{size:48,color:r.textMuted,style:{marginBottom:"16px",opacity:.5}}),t.jsx("p",{style:{color:r.textSecondary,margin:0},children:c==="unread"?"Nessuna notifica non letta":"Nessuna notifica"})]}):t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"12px"},children:L.map((e,a)=>{const o=R(e);return t.jsx(y.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:a*.03},onClick:()=>!o&&B(e.id),style:{...D,padding:"16px",cursor:o?"default":"pointer",borderColor:o?r.border:r.accent,opacity:o?.7:1},children:t.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"12px"},children:[t.jsx("div",{style:{marginTop:"2px"},children:W(e.type)}),t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx("h3",{style:{fontWeight:"600",color:r.textPrimary,margin:0,fontSize:"15px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.title}),!o&&t.jsx("span",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:r.accent,flexShrink:0}})]}),t.jsx("p",{style:{fontSize:"14px",marginTop:"4px",marginBottom:0,color:r.textSecondary},children:e.body}),t.jsx("p",{style:{fontSize:"12px",marginTop:"8px",marginBottom:0,color:r.textMuted},children:O(e.created_at)})]}),o&&t.jsx(V,{size:16,color:r.textMuted})]})},e.id)})})]})})};export{se as Notifiche};
