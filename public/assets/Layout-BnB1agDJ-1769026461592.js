import{u as ye,w as F,J as ve,a as V,r as m,x as H,ba as Y,j as t,m as je,b as ee,E as te,aw as ae,a8 as ne,K as J,O as Z,Y as q,Z as ke,H as D,$ as Se,bb as U,aa as g,p as O,bc as ie,bd as ce,h as le,a4 as de,y as pe,aZ as xe,az as ue,be as we,A as $e,L as X,aF as ge,aE as ze}from"./index-B7WG_kHJ-1769026461592.js";import{m as j}from"./motion-DSM7Rpg2-1769026461592.js";import{A as re}from"./index-yirOBEcN-1769026461592.js";import{u as Ce}from"./useTranslation-CnXjuBvM-1769026461592.js";import{s as N,r as _,g as Q,f as fe}from"./responsive-BJrBEfWo-1769026461592.js";import{o as T}from"./omniapiApi-DDnppdd_-1769026461592.js";const se=a=>{const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return n?`${parseInt(n[1],16)}, ${parseInt(n[2],16)}, ${parseInt(n[3],16)}`:"106, 212, 160"},he=({variant:a="mobile"})=>{const n=ye(),{impiantoCorrente:e,setImpiantoCorrente:r,impianti:i,loading:x,refresh:f}=F(),{removeImpianto:b}=ve(),{user:d}=V(),[u,k]=m.useState(!1),[S,z]=m.useState([]),[c,C]=m.useState(!1),{colors:L,modeColors:E,isDarkMode:y}=H(),h=(d==null?void 0:d.ruolo)!=="proprietario",v=m.useCallback(async()=>{try{const o=await Y.getInvitiPendenti();o.success&&z(o.data||[])}catch(o){console.error("Errore caricamento inviti:",o)}},[]);m.useEffect(()=>{v()},[v]),m.useEffect(()=>{u&&v()},[u,v]);const I=async(o,p)=>{var $,w;o.stopPropagation(),C(!0);try{(await Y.accettaInvito(p)).success&&(D.success("Invito accettato!"),z(M=>M.filter(G=>G.id!==p)),await f())}catch(R){D.error(((w=($=R.response)==null?void 0:$.data)==null?void 0:w.error)||"Errore nell'accettare l'invito")}finally{C(!1)}},B=async(o,p)=>{var $,w;o.stopPropagation(),C(!0);try{(await Y.rifiutaInvito(p)).success&&(D.success("Invito rifiutato"),z(M=>M.filter(G=>G.id!==p)))}catch(R){D.error(((w=($=R.response)==null?void 0:$.data)==null?void 0:w.error)||"Errore nel rifiutare l'invito")}finally{C(!1)}},s=m.useMemo(()=>({...E,accent:L.accent,accentLight:L.accentLight,border:`rgba(${se(L.accent)}, 0.15)`,borderHover:`rgba(${se(L.accent)}, 0.35)`}),[L,E]),W=()=>{k(!1),n("/setup")},l=async(o,p,$)=>{var w,R;if(o.stopPropagation(),!!confirm(`Sei sicuro di voler eliminare l'impianto "${$}"? Questa azione è irreversibile.`))try{k(!1),await Se.delete(p),b(p),D.success("Impianto eliminato con successo!"),i.length<=1?n("/",{replace:!0}):await f()}catch(M){console.error("Errore eliminazione impianto:",M),D.error(((R=(w=M.response)==null?void 0:w.data)==null?void 0:R.error)||"Errore durante l'eliminazione")}};return x?t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 12px"},children:[t.jsx(je,{size:16,className:"animate-spin",style:{color:s.accent}}),t.jsx("span",{style:{fontSize:"14px",color:s.textMuted},children:"Caricamento..."})]}):!e||i.length===0?S.length>0?t.jsxs("div",{style:{position:"relative"},children:[t.jsxs(j.button,{onClick:()=>k(!u),style:{width:"100%",display:"flex",alignItems:"center",gap:"8px",padding:"10px 12px",background:a==="desktop"?s.bgCardLit:"transparent",border:a==="desktop"?`1px solid ${s.accent}40`:`1px solid ${s.accent}30`,borderRadius:"16px",cursor:"pointer"},whileHover:{background:y?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.03)"},children:[t.jsx(ee,{size:18,style:{color:s.accent}}),t.jsxs("span",{style:{flex:1,fontSize:"13px",fontWeight:500,color:s.accent,textAlign:"left"},children:[S.length," invit",S.length===1?"o":"i"," in attesa"]}),t.jsx(j.div,{animate:{rotate:u?180:0},transition:{duration:.2},children:t.jsx(te,{size:16,style:{color:s.accent}})})]}),t.jsx(re,{children:u&&t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{position:"fixed",inset:0,zIndex:40},onClick:()=>k(!1)}),t.jsxs(j.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:{duration:.15},style:{position:"absolute",zIndex:50,width:"100%",top:"100%",marginTop:"4px",background:s.bgCardLit,borderRadius:"16px",border:`1px solid ${s.border}`,boxShadow:s.cardShadowLit,overflow:"hidden",maxHeight:"280px",overflowY:"auto"},children:[t.jsx("div",{style:{padding:"10px 12px",background:y?"rgba(255, 255, 255, 0.03)":"rgba(0, 0, 0, 0.02)",borderBottom:`1px solid ${s.border}`},children:t.jsx("span",{style:{fontSize:"12px",fontWeight:600,color:s.accent},children:"Inviti Ricevuti"})}),S.map(o=>t.jsxs("div",{style:{padding:"12px",borderBottom:`1px solid ${s.border}`,background:y?"rgba(106, 212, 160, 0.05)":"rgba(106, 212, 160, 0.08)"},children:[t.jsxs("div",{style:{marginBottom:"8px"},children:[t.jsx("p",{style:{fontSize:"13px",fontWeight:500,color:s.textPrimary,margin:0},children:o.impianto_nome}),t.jsxs("p",{style:{fontSize:"11px",color:s.textMuted,margin:"2px 0 0 0"},children:["da ",o.invitato_da_nome," • ",o.ruolo_condivisione]})]}),t.jsxs("div",{style:{display:"flex",gap:"8px"},children:[t.jsxs(j.button,{onClick:p=>I(p,o.id),disabled:c,style:{flex:1,padding:"6px 10px",borderRadius:"8px",background:`${s.accent}20`,border:`1px solid ${s.accent}50`,color:s.accent,fontSize:"12px",fontWeight:500,cursor:c?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"4px",opacity:c?.6:1},whileHover:c?{}:{background:`${s.accent}30`},whileTap:c?{}:{scale:.98},children:[t.jsx(ae,{size:14}),"Accetta"]}),t.jsxs(j.button,{onClick:p=>B(p,o.id),disabled:c,style:{flex:1,padding:"6px 10px",borderRadius:"8px",background:"transparent",border:`1px solid ${s.textMuted}50`,color:s.textMuted,fontSize:"12px",fontWeight:500,cursor:c?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"4px",opacity:c?.6:1},whileHover:c?{}:{background:y?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)"},whileTap:c?{}:{scale:.98},children:[t.jsx(ne,{size:14}),"Rifiuta"]})]})]},o.id)),h&&t.jsx("div",{style:{borderTop:`1px solid ${s.border}`},children:t.jsxs(j.button,{onClick:W,style:{width:"100%",display:"flex",alignItems:"center",gap:"8px",padding:"12px",textAlign:"left",background:"transparent",border:"none",cursor:"pointer"},whileHover:{background:y?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.03)"},children:[t.jsx(J,{size:16,style:{color:s.accent}}),t.jsx("span",{style:{fontSize:"14px",fontWeight:500,color:s.accent},children:"Crea nuovo impianto"})]})})]})]})})]}):h?t.jsxs(j.button,{onClick:W,style:{width:"100%",display:"flex",alignItems:"center",gap:"8px",padding:"10px 12px",background:a==="desktop"?s.bgCardLit:"transparent",border:a==="desktop"?`1px solid ${s.border}`:"none",borderRadius:"16px",cursor:"pointer"},whileHover:{background:a==="desktop"?y?"linear-gradient(165deg, #2a2722 0%, #1e1c18 50%, #1a1816 100%)":s.bgSecondary:y?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.03)",borderColor:s.borderHover},children:[t.jsx(J,{size:18,style:{color:s.accent}}),t.jsx("span",{style:{fontSize:"14px",fontWeight:600,color:s.accent},children:"Crea nuovo impianto"})]}):t.jsxs("div",{style:{width:"100%",display:"flex",alignItems:"center",gap:"8px",padding:"10px 12px",background:a==="desktop"?s.bgCardLit:"transparent",border:a==="desktop"?`1px solid ${s.border}`:"none",borderRadius:"16px"},children:[t.jsx(Z,{size:18,style:{color:s.textMuted}}),t.jsx("span",{style:{fontSize:"13px",color:s.textMuted},children:"Nessun impianto disponibile"})]}):t.jsxs("div",{style:{position:"relative"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",width:"100%"},children:[t.jsxs(j.button,{onClick:()=>k(!u),style:{flex:1,display:"flex",alignItems:"center",gap:"8px",padding:"10px 12px",background:a==="desktop"?s.bgCardLit:"transparent",border:a==="desktop"?`1px solid ${s.border}`:"none",borderRadius:"16px",cursor:"pointer"},whileHover:{background:a==="desktop"?y?"linear-gradient(165deg, #2a2722 0%, #1e1c18 50%, #1a1816 100%)":s.bgSecondary:y?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.03)"},children:[t.jsx(Z,{size:18,style:{color:s.accent}}),t.jsxs("div",{style:{flex:1,textAlign:"left"},children:[t.jsx("p",{style:{fontSize:"14px",fontWeight:600,color:s.textPrimary,margin:0},children:e.nome}),t.jsx("p",{style:{fontSize:"12px",color:s.textMuted,margin:0},children:e.citta})]}),t.jsx(j.div,{animate:{rotate:u?180:0},transition:{duration:.2},children:t.jsx(te,{size:16,style:{color:s.textMuted}})})]}),t.jsx(j.button,{onClick:o=>{o.stopPropagation(),n("/impianto/settings")},style:{padding:"10px",borderRadius:"12px",background:a==="desktop"?s.bgCardLit:"transparent",border:a==="desktop"?`1px solid ${s.border}`:`1px solid ${s.border}`,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},whileHover:{background:y?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.05)",borderColor:s.accent},whileTap:{scale:.95},title:"Impostazioni impianto",children:t.jsx(q,{size:18,style:{color:s.accent}})})]}),t.jsx(re,{children:u&&t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{position:"fixed",inset:0,zIndex:40},onClick:()=>k(!1)}),t.jsxs(j.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:{duration:.15},style:{position:"absolute",zIndex:50,width:"100%",top:"100%",marginTop:"4px",background:s.bgCardLit,borderRadius:"16px",border:`1px solid ${s.border}`,boxShadow:s.cardShadowLit,overflow:"hidden",maxHeight:"320px",overflowY:"auto"},children:[S.length>0&&t.jsxs("div",{style:{borderBottom:`1px solid ${s.border}`},children:[t.jsxs("div",{style:{padding:"8px 12px",display:"flex",alignItems:"center",gap:"6px",background:y?"rgba(255, 255, 255, 0.03)":"rgba(0, 0, 0, 0.02)"},children:[t.jsx(ee,{size:14,style:{color:s.accent}}),t.jsxs("span",{style:{fontSize:"12px",fontWeight:600,color:s.accent},children:["Inviti (",S.length,")"]})]}),S.map(o=>t.jsxs("div",{style:{padding:"10px 12px",borderTop:`1px solid ${s.border}`,background:y?"rgba(106, 212, 160, 0.05)":"rgba(106, 212, 160, 0.08)"},children:[t.jsxs("div",{style:{marginBottom:"8px"},children:[t.jsx("p",{style:{fontSize:"13px",fontWeight:500,color:s.textPrimary,margin:0},children:o.impianto_nome}),t.jsxs("p",{style:{fontSize:"11px",color:s.textMuted,margin:"2px 0 0 0"},children:["da ",o.invitato_da_nome," • ",o.ruolo_condivisione]})]}),t.jsxs("div",{style:{display:"flex",gap:"8px"},children:[t.jsxs(j.button,{onClick:p=>I(p,o.id),disabled:c,style:{flex:1,padding:"6px 10px",borderRadius:"8px",background:`${s.accent}20`,border:`1px solid ${s.accent}50`,color:s.accent,fontSize:"12px",fontWeight:500,cursor:c?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"4px",opacity:c?.6:1},whileHover:c?{}:{background:`${s.accent}30`},whileTap:c?{}:{scale:.98},children:[t.jsx(ae,{size:14}),"Accetta"]}),t.jsxs(j.button,{onClick:p=>B(p,o.id),disabled:c,style:{flex:1,padding:"6px 10px",borderRadius:"8px",background:"transparent",border:`1px solid ${s.textMuted}50`,color:s.textMuted,fontSize:"12px",fontWeight:500,cursor:c?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"4px",opacity:c?.6:1},whileHover:c?{}:{background:y?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)"},whileTap:c?{}:{scale:.98},children:[t.jsx(ne,{size:14}),"Rifiuta"]})]})]},o.id))]}),i.map(o=>t.jsxs("div",{style:{display:"flex",alignItems:"center",transition:"all 0.2s",background:o.id===e.id?`${s.accent}15`:"transparent",borderLeft:o.id===e.id?`2px solid ${s.accent}`:"2px solid transparent"},children:[t.jsxs("button",{onClick:()=>{r(o),k(!1)},style:{flex:1,display:"flex",alignItems:"center",gap:"8px",padding:"12px",textAlign:"left",background:"transparent",border:"none",cursor:"pointer"},children:[t.jsx(Z,{size:16,style:{color:o.id===e.id?s.accent:s.textMuted}}),t.jsxs("div",{style:{flex:1},children:[t.jsx("p",{style:{fontSize:"14px",fontWeight:500,color:o.id===e.id?s.accent:s.textPrimary,margin:0},children:o.nome}),t.jsx("p",{style:{fontSize:"12px",color:s.textMuted,margin:0},children:o.citta})]})]}),t.jsx(j.button,{onClick:p=>l(p,o.id,o.nome),style:{padding:"8px",marginRight:"8px",background:"transparent",border:"none",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},whileHover:{background:`${s.error}20`},title:"Elimina impianto",children:t.jsx(ke,{size:14,style:{color:`${s.error}aa`}})})]},o.id)),h&&t.jsx("div",{style:{borderTop:`1px solid ${s.border}`},children:t.jsxs(j.button,{onClick:W,style:{width:"100%",display:"flex",alignItems:"center",gap:"8px",padding:"12px",textAlign:"left",background:"transparent",border:"none",cursor:"pointer"},whileHover:{background:y?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.03)"},children:[t.jsx(J,{size:16,style:{color:s.accent}}),t.jsx("span",{style:{fontSize:"14px",fontWeight:500,color:s.accent},children:"Crea nuovo impianto"})]})})]})]})})]})},be=()=>{const[a,n]=m.useState(null),[e,r]=m.useState(!1);return m.useEffect(()=>{(()=>{const u=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0;r(u)})();const b=u=>{u.preventDefault(),n(u)},d=()=>{n(null),r(!0)};return window.addEventListener("beforeinstallprompt",b),window.addEventListener("appinstalled",d),()=>{window.removeEventListener("beforeinstallprompt",b),window.removeEventListener("appinstalled",d)}},[]),{isStandalone:e,canInstall:!e&&a!==null,promptInstall:async()=>{if(!a)return!1;a.prompt();const{outcome:f}=await a.userChoice;return n(null),f==="accepted"?(r(!0),!0):!1}}};let A=null;const me=U((a,n)=>({unreadCount:0,loading:!1,lastFetch:null,listenerRegistered:!1,fetchUnreadCount:async e=>{const r=Date.now(),i=n().lastFetch;if(!(i&&r-i<1e4)&&e){a({loading:!0});try{const x=await O.get(`/api/notifications/history?impiantoId=${e}&limit=1`);a({unreadCount:x.data.unreadCount||0,loading:!1,lastFetch:r})}catch(x){console.error("Errore fetch unreadCount:",x),a({loading:!1})}}},resetUnreadCount:()=>{a({unreadCount:0})},decrementUnreadCount:()=>{a(e=>({unreadCount:Math.max(0,e.unreadCount-1)}))},incrementUnreadCount:()=>{a(e=>({unreadCount:e.unreadCount+1}))},initWebSocketListener:()=>{var e;n().listenerRegistered||A||(A=r=>{r.tipo!=="condivisione-rimossa"&&a(i=>({unreadCount:i.unreadCount+1}))},(e=g.getSocket())==null||e.on("notification",A),a({listenerRegistered:!0}))},cleanupWebSocketListener:()=>{var e;A&&((e=g.getSocket())==null||e.off("notification",A),A=null,a({listenerRegistered:!1}))}})),oe=a=>{const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return n?`${parseInt(n[1],16)}, ${parseInt(n[2],16)}, ${parseInt(n[3],16)}`:"106, 212, 160"},Le=()=>{const{t:a}=Ce(),n=ie(),{logout:e}=V(),{colors:r,colorTheme:i,modeColors:x,isDarkMode:f}=H(),{canInstall:b,promptInstall:d}=be(),{impiantoCorrente:u}=F(),{unreadCount:k,fetchUnreadCount:S,initWebSocketListener:z}=me();m.useEffect(()=>{u!=null&&u.id&&S(u.id),z()},[u==null?void 0:u.id,S,z]);const c=m.useMemo(()=>({...x,accent:r.accent,accentLight:r.accentLight,accentDark:r.accentDark,border:`rgba(${oe(r.accent)}, 0.15)`}),[r,x]),{canAccessPath:C}=ce(),E=[{path:"/dashboard",icon:le,label:a("nav.dashboard")},{path:"/stanze",icon:de,label:"Stanze"},{path:"/dispositivi",icon:pe,label:a("nav.dispositivi")},{path:"/scene",icon:xe,label:a("nav.scene")},{path:"/notifications",icon:ue,label:"Notifiche"},{path:"/settings",icon:q,label:a("nav.settings")}].filter(h=>C(h.path)),y=h=>n.pathname.startsWith(h);return t.jsxs("aside",{className:"w-64 h-screen p-4 flex flex-col relative overflow-hidden",style:{background:c.bgCardLit,borderRight:`1px solid ${c.border}`,boxShadow:c.cardShadow},children:[t.jsx("div",{style:{position:"absolute",top:0,left:"25%",right:"25%",height:"1px",background:`linear-gradient(90deg, transparent, ${c.accentLight}4D, transparent)`,pointerEvents:"none"}}),t.jsxs("div",{className:"mb-8 px-2",children:[t.jsx("h1",{className:"text-2xl font-bold",style:{background:`linear-gradient(135deg, ${c.accentLight}, ${c.accent}, ${c.accentDark})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:`0 0 40px ${c.accent}30`},children:we},`logo-${i}`),t.jsxs("p",{style:{color:c.textMuted,fontSize:"12px"},children:[a("app.title")," ",t.jsx("span",{style:{color:c.accent,fontWeight:600},children:$e})]})]}),t.jsx("div",{className:"mb-6",children:t.jsx(he,{variant:"desktop"})}),t.jsx("nav",{className:"flex-1 space-y-2",children:E.map(h=>{const v=y(h.path),I=h.path==="/notifications";return t.jsx(X,{to:h.path,children:t.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 transition-all",style:{borderRadius:"20px",background:v?`linear-gradient(165deg, ${c.accentDark}, ${c.accent})`:"transparent",color:v?f?"#0a0a0c":"#ffffff":c.textSecondary,boxShadow:v?`0 4px 16px ${c.accent}30`:"none",fontWeight:v?600:500},children:[t.jsx(h.icon,{size:20,className:"flex-shrink-0",style:{filter:"none"}}),t.jsx("span",{style:{fontSize:"14px",flex:1},children:h.label}),I&&k>0&&t.jsx("span",{style:{minWidth:"20px",height:"20px",padding:"0 6px",fontSize:"11px",fontWeight:700,color:v?c.accent:"#fff",backgroundColor:v?f?"#0a0a0c":"#ffffff":c.accent,borderRadius:"10px",display:"flex",alignItems:"center",justifyContent:"center"},children:k>99?"99+":k})]})},h.path)})}),b&&t.jsxs("button",{onClick:d,className:"flex items-center gap-3 px-4 py-3 w-full transition-all hover:scale-[0.98] relative overflow-hidden mb-2",style:{borderRadius:"20px",color:c.accent,background:`rgba(${oe(c.accent)}, 0.15)`,border:`1px solid ${c.accent}33`,cursor:"pointer"},children:[t.jsx("span",{className:"absolute inset-0 rounded-xl animate-pulse",style:{backgroundColor:c.accent,opacity:.1}}),t.jsx(ge,{size:20,className:"flex-shrink-0 relative z-10"}),t.jsx("span",{style:{fontWeight:600,fontSize:"14px"},className:"relative z-10",children:"Installa App"})]}),t.jsxs("button",{onClick:e,className:"flex items-center gap-3 px-4 py-3 w-full transition-all hover:scale-[0.98]",style:{borderRadius:"20px",color:c.textSecondary,background:"transparent",border:"none",cursor:"pointer"},onMouseEnter:h=>{h.currentTarget.style.background="rgba(239, 68, 68, 0.15)",h.currentTarget.style.color="#ef4444"},onMouseLeave:h=>{h.currentTarget.style.background="transparent",h.currentTarget.style.color=c.textSecondary},children:[t.jsx(ze,{size:20,className:"flex-shrink-0"}),t.jsx("span",{style:{fontWeight:500,fontSize:"14px"},children:a("auth.logout")})]})]})},Ie=a=>{const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return n?`${parseInt(n[1],16)}, ${parseInt(n[2],16)}, ${parseInt(n[3],16)}`:"106, 212, 160"},Re=()=>{const a=ie(),{colors:n,modeColors:e}=H(),r=m.useMemo(()=>({...e,accent:n.accent,accentLight:n.accentLight,border:`rgba(${Ie(n.accent)}, 0.15)`}),[n,e]),{canAccessPath:i}=ce(),f=[{path:"/dashboard",icon:le,label:"Home"},{path:"/stanze",icon:de,label:"Stanze"},{path:"/dispositivi",icon:pe,label:"Dispositivi"},{path:"/scene",icon:xe,label:"Scene"},{path:"/settings",icon:q,label:"Altro"}].filter(d=>i(d.path)),b=d=>a.pathname.startsWith(d);return t.jsx("nav",{className:"flex-shrink-0 md:hidden",style:{paddingBottom:"env(safe-area-inset-bottom, 0px)"},children:t.jsxs("div",{className:"flex items-center justify-around relative overflow-hidden",style:{padding:`${N.xs} ${N.md}`,background:r.bgCardLit,borderTop:`1px solid ${r.border}`,backdropFilter:"blur(20px)",boxShadow:"0 -8px 32px rgba(0, 0, 0, 0.5), 0 -2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.06)"},children:[t.jsx("div",{style:{position:"absolute",top:0,left:"25%",right:"25%",height:"1px",background:`linear-gradient(90deg, transparent, ${r.accentLight}4D, transparent)`}}),f.map(d=>{const u=b(d.path);return t.jsxs(X,{to:d.path,className:"transition-all flex flex-col items-center gap-0.5",style:{padding:N.xs,background:u?`${r.accent}15`:"transparent",borderRadius:_.lg,boxShadow:u?`0 0 12px ${r.accent}30`:"none"},children:[t.jsx(d.icon,{size:Q("sm"),style:{color:u?r.accentLight:r.textMuted,filter:u?`drop-shadow(0 0 4px ${r.accent})`:"none"}}),t.jsx("span",{style:{fontSize:fe.xs,fontWeight:500,color:u?r.accentLight:r.textMuted},children:d.label})]},d.path)})]})})},K=a=>{const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return n?`${parseInt(n[1],16)}, ${parseInt(n[2],16)}, ${parseInt(n[3],16)}`:"106, 212, 160"},Ne=()=>{const{colors:a,modeColors:n}=H(),{impiantoCorrente:e}=F(),{unreadCount:r,fetchUnreadCount:i,initWebSocketListener:x}=me(),{canInstall:f,promptInstall:b}=be(),d=m.useMemo(()=>({...n,accent:a.accent,accentLight:a.accentLight,border:`rgba(${K(a.accent)}, 0.15)`}),[a,n]);return m.useEffect(()=>(e!=null&&e.id&&(i(e.id),g.joinImpianto(e.id)),x(),()=>{e!=null&&e.id&&g.leaveImpianto(e.id)}),[e==null?void 0:e.id,i,x]),t.jsxs("div",{className:"md:hidden flex-shrink-0",style:{background:d.bgCardLit,borderBottom:`1px solid ${d.border}`,boxShadow:d.cardShadow,paddingTop:"env(safe-area-inset-top, 0px)"},children:[t.jsx("div",{style:{position:"absolute",top:0,left:"25%",right:"25%",height:"1px",background:`linear-gradient(90deg, transparent, ${d.accentLight}4D, transparent)`}}),t.jsxs("div",{className:"flex items-center justify-between",style:{padding:`${N.sm} ${N.md}`},children:[t.jsx("div",{className:"flex-1",children:t.jsx(he,{variant:"mobile"})}),f&&t.jsxs("button",{onClick:b,className:"relative ml-2",style:{padding:N.xs,background:`rgba(${K(d.accent)}, 0.15)`,borderRadius:_.md},children:[t.jsx("span",{className:"absolute inset-0 animate-ping",style:{backgroundColor:d.accent,opacity:.25,animationDuration:"2s",borderRadius:_.md}}),t.jsx("span",{className:"absolute inset-0 animate-pulse",style:{backgroundColor:d.accent,opacity:.15,animationDuration:"1.5s",borderRadius:_.md}}),t.jsx(ge,{size:Q("sm"),style:{color:d.accent},className:"relative z-10"})]}),t.jsxs(X,{to:"/notifications",className:"relative ml-2",style:{padding:N.xs,background:`rgba(${K(d.accent)}, 0.1)`,borderRadius:_.md},children:[t.jsx(ue,{size:Q("md"),color:d.accentLight}),r>0&&t.jsx("span",{style:{position:"absolute",top:"4px",right:"4px",minWidth:"16px",height:"16px",padding:"0 4px",fontSize:fe.xs,fontWeight:"bold",color:"white",backgroundColor:d.accent,borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center"},children:r>99?"99+":r})]})]})]})},Ee=U(a=>({stanze:[],loading:!1,error:null,fetchStanze:async n=>{a({loading:!0,error:null});try{const{data:e}=await O.get(`/api/impianti/${n}/stanze`);a({stanze:Array.isArray(e)?e:[],loading:!1})}catch(e){console.error("Errore fetch stanze:",e),a({error:e.message,loading:!1})}},addStanza:n=>{a(e=>({stanze:[...e.stanze,n]}))},updateStanza:n=>{a(e=>({stanze:e.stanze.map(r=>r.id===n.id?{...r,...n}:r)}))},removeStanza:n=>{a(e=>({stanze:e.stanze.filter(r=>r.id!==n)}))},setStanze:n=>{a({stanze:n})}})),Me=U(a=>({scene:[],loading:!1,error:null,fetchScene:async n=>{a({loading:!0,error:null});try{const{data:e}=await O.get(`/api/impianti/${n}/scene`);a({scene:Array.isArray(e)?e:[],loading:!1})}catch(e){console.error("Errore fetch scene:",e),a({error:e.message,loading:!1})}},addScena:n=>{a(e=>({scene:[...e.scene,n]}))},updateScena:n=>{a(e=>({scene:e.scene.map(r=>r.id===n.id?{...r,...n}:r)}))},removeScena:n=>{a(e=>({scene:e.scene.filter(r=>r.id!==n)}))},setScene:n=>{a({scene:n})},markExecuted:n=>{a(e=>({scene:e.scene.map(r=>r.id===n?{...r,lastExecuted:new Date().toISOString()}:r)}))}})),P=U(a=>({dispositivi:[],loading:!1,error:null,fetchDispositivi:async n=>{a({loading:!0,error:null});try{const{data:e}=await O.get(`/api/impianti/${n}/dispositivi/all`);a({dispositivi:Array.isArray(e)?e:[],loading:!1})}catch(e){console.error("Errore fetch dispositivi:",e),a({error:e.message,loading:!1})}},addDispositivo:n=>{a(e=>({dispositivi:[...e.dispositivi,n]}))},updateDispositivo:n=>{a(e=>({dispositivi:e.dispositivi.map(r=>r.id===n.id?{...r,...n}:r)}))},removeDispositivo:n=>{a(e=>({dispositivi:e.dispositivi.filter(r=>r.id!==n)}))},setDispositivi:n=>{a({dispositivi:n})},updatePowerState:(n,e)=>{a(r=>({dispositivi:r.dispositivi.map(i=>i.id===n?{...i,power_state:e,stato:"online"}:i)}))},updateLedState:(n,e)=>{a(r=>({dispositivi:r.dispositivi.map(i=>i.id===n?{...i,...e,stato:"online"}:i)}))},updateByMac:(n,e)=>{a(r=>({dispositivi:r.dispositivi.map(i=>i.mac_address===n?{...i,...e}:i)}))}})),De=U((a,n)=>({gateway:null,nodes:[],ledDevices:[],isLoading:!1,error:null,fetchGateway:async()=>{try{const e=await T.getGateway();a({gateway:e,error:null})}catch(e){console.error("Errore fetch gateway:",e),a({error:e.message||"Errore caricamento gateway"})}},fetchNodes:async()=>{a({isLoading:!0});try{const e=await T.getNodes();a({nodes:e.nodes||[],isLoading:!1,error:null})}catch(e){console.error("Errore fetch nodes:",e),a({isLoading:!1,error:e.message||"Errore caricamento nodi"})}},sendCommand:async(e,r,i)=>{try{await T.sendCommand(e,r,i);const x=n().nodes.map(f=>{if(f.mac===e){const b=i==="toggle"?r===1?!f.relay1:!f.relay2:i==="on";return{...f,relay1:r===1?b:f.relay1,relay2:r===2?b:f.relay2}}return f});return a({nodes:x}),!0}catch(x){return console.error("Errore invio comando:",x),!1}},updateGateway:e=>{a({gateway:e})},updateNode:e=>{a(r=>({nodes:r.nodes.map(i=>i.mac===e.mac?{...i,...e}:i)}))},updateNodes:e=>{a({nodes:e})},fetchLedDevices:async()=>{try{const e=await T.getLedDevices();a({ledDevices:e.devices||[]})}catch(e){console.error("Errore fetch LED devices:",e)}},sendLedCommand:async(e,r,i)=>{try{return await T.sendLedCommand(e,r,i),!0}catch(x){return console.error("Errore invio comando LED:",x),!1}},updateLedDevice:e=>{a(r=>{const i=r.ledDevices.findIndex(x=>x.mac===e.mac);if(i>=0){const x=[...r.ledDevices];return x[i]={...x[i],...e},{ledDevices:x}}else return{ledDevices:[...r.ledDevices,e]}})},setLedDevices:e=>{a({ledDevices:e})}})),Ae=a=>{const n=m.useRef(!1),e=m.useRef(null),r=V(l=>l.token),{addStanza:i,updateStanza:x,removeStanza:f,setStanze:b,fetchStanze:d}=Ee(),{addScena:u,updateScena:k,removeScena:S,setScene:z,fetchScene:c,markExecuted:C}=Me(),{addDispositivo:L,updateDispositivo:E,removeDispositivo:y,setDispositivi:h,updatePowerState:v,fetchDispositivi:I}=P(),{updateNode:B,updateNodes:s,updateLedDevice:W}=De();return m.useEffect(()=>{if(!(!a||!r)&&(e.current&&e.current!==a&&(g.leaveImpianto(e.current),n.current=!1),!(n.current&&e.current===a)))return g.isConnected()||g.connect(r),g.joinImpianto(a),e.current=a,d(a),c(a),I(a),g.onStanzaUpdate(({stanza:l,action:o})=>{switch(o){case"created":i(l);break;case"updated":x(l);break;case"deleted":f(l.id);break}}),g.onScenaUpdate(({scena:l,action:o})=>{switch(o){case"created":u(l);break;case"updated":k(l);break;case"executed":C(l.id);break;case"deleted":S(l.id);break}}),g.onDispositivoUpdate(({dispositivo:l,action:o})=>{switch(o){case"created":L(l);break;case"updated":E(l);break;case"deleted":y(l.id);break;case"state-changed":v(l.id,l.power_state);break}}),g.onOmniapiNodeUpdate(l=>{B(l);const o=P.getState().dispositivi.find(p=>p.mac_address===l.mac);if(o){const p=l.relay1||l.relay2;v(o.id,p)}}),g.onOmniapiNodesUpdate(l=>{s(l);const o=P.getState().dispositivi;l.forEach(p=>{const $=o.find(w=>w.mac_address===p.mac);if($){const w=p.relay1||p.relay2;v($.id,w)}})}),g.onOmniapiLedUpdate(l=>{W(l),P.getState().dispositivi.find(p=>p.mac_address===l.mac)&&P.getState().updateByMac(l.mac,{led_power:l.power,power_state:l.power,led_r:l.r,led_g:l.g,led_b:l.b,led_brightness:l.brightness,led_effect:l.effect,online:l.online,stato:l.online!==!1?"online":"offline"})}),g.onFullSync(({stanze:l,scene:o,dispositivi:p})=>{l&&b(l),o&&z(o),p&&h(p)}),n.current=!0,()=>{g.offStanzaUpdate(),g.offScenaUpdate(),g.offDispositivoUpdate(),g.offOmniapiNodeUpdate(),g.offOmniapiNodesUpdate(),g.offOmniapiLedUpdate(),g.offFullSync()}},[a,r]),m.useEffect(()=>()=>{e.current&&g.leaveImpianto(e.current),n.current=!1,e.current=null},[]),{isConnected:g.isConnected(),reconnect:()=>{r&&(g.disconnect(),g.connect(r),a&&(g.joinImpianto(a),d(a),c(a),I(a)))},refresh:()=>{a&&(d(a),c(a),I(a))}}},We=a=>{const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return n?`${parseInt(n[1],16)}, ${parseInt(n[2],16)}, ${parseInt(n[3],16)}`:"106, 212, 160"},Fe=({children:a})=>{const{colors:n,modeColors:e,isDarkMode:r}=H(),{impiantoCorrente:i}=F();Ae((i==null?void 0:i.id)??null);const{bgGradient:x,ambientGlow:f}=m.useMemo(()=>{const b=We(n.accent);return r?{bgGradient:`radial-gradient(ellipse 80% 50% at 50% -10%, rgba(${b}, 0.08) 0%, transparent 60%), linear-gradient(to bottom, #12110f 0%, #0a0a09 100%)`,ambientGlow:`radial-gradient(ellipse 100% 40% at 50% 0%, rgba(${b}, 0.06) 0%, transparent 70%)`}:{bgGradient:`radial-gradient(ellipse 80% 50% at 50% -10%, rgba(${b}, 0.05) 0%, transparent 60%), linear-gradient(to bottom, ${e.bg} 0%, ${e.bgSecondary} 100%)`,ambientGlow:`radial-gradient(ellipse 100% 40% at 50% 0%, rgba(${b}, 0.04) 0%, transparent 70%)`}},[n.accent,r,e]);return t.jsxs("div",{className:"flex flex-col md:flex-row overflow-hidden",style:{height:"100dvh",background:x,fontFamily:'"Plus Jakarta Sans", -apple-system, BlinkMacSystemFont, sans-serif'},children:[t.jsx("div",{className:"fixed inset-0 pointer-events-none z-0",style:{background:f}}),t.jsx("aside",{className:"hidden md:flex md:flex-shrink-0 relative z-10",children:t.jsx(Le,{})}),t.jsxs("div",{className:"flex-1 flex flex-col min-h-0 min-w-0 relative z-10",children:[t.jsx(Ne,{}),t.jsx("main",{className:"flex-1 overflow-y-auto",style:{padding:N.lg},children:t.jsx("div",{className:"max-w-5xl mx-auto w-full",children:a})}),t.jsx(Re,{})]})]})};export{Fe as L,Me as a,P as b,be as c,me as d,Ee as u};
