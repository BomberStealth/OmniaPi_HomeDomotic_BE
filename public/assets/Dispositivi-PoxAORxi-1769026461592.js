import{x as A,r as _,j as t,a8 as K,a9 as q,B as J,H as d,w as Q,a2 as X,K as Y,y as Z,G as ee}from"./index-B7WG_kHJ-1769026461592.js";import{b as te,L as re}from"./Layout-BnB1agDJ-1769026461592.js";import{u as ne,U as z}from"./UnifiedDeviceCard-BHanxt9p-1769026461592.js";import{D as ae}from"./DeviceDiscovery-BuZB5vA_-1769026461592.js";import{u as ie}from"./useThemeColors-DHOyp60z-1769026461592.js";import{o as y}from"./omniapiApi-DDnppdd_-1769026461592.js";import{A as se}from"./index-yirOBEcN-1769026461592.js";import{m as g}from"./motion-DSM7Rpg2-1769026461592.js";import"./useTranslation-CnXjuBvM-1769026461592.js";import"./responsive-BJrBEfWo-1769026461592.js";import"./Toggle-B6i1zhXp-1769026461592.js";const N=a=>{const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return n?`${parseInt(n[1],16)}, ${parseInt(n[2],16)}, ${parseInt(n[3],16)}`:"106, 212, 160"},C=({variant:a="text",width:n,height:p,className:u=""})=>{const{colors:b,isDarkMode:i}=A(),o=N(b.accent),j=()=>{switch(a){case"circular":return"50%";case"text":return"8px";case"rectangular":return"16px";case"card":return"24px";default:return"8px"}},h=()=>{switch(a){case"text":return"16px";case"card":return"128px";default:return}},m=n?typeof n=="number"?`${n}px`:n:"100%",f=p?typeof p=="number"?`${p}px`:p:a==="circular"?m:h(),L=i?`linear-gradient(90deg, rgba(42, 39, 34, 0.5) 0%, rgba(${o}, 0.08) 50%, rgba(42, 39, 34, 0.5) 100%)`:`linear-gradient(90deg, rgba(220, 220, 220, 0.5) 0%, rgba(${o}, 0.08) 50%, rgba(220, 220, 220, 0.5) 100%)`;return t.jsx("div",{className:`animate-pulse ${u}`,style:{width:m,height:f,background:L,backgroundSize:"200% 100%",borderRadius:j()}})},oe=({count:a=3})=>{const{colors:n,modeColors:p}=A(),u=_.useMemo(()=>{const b=N(n.accent);return{...p,accentLight:n.accentLight,border:`rgba(${b}, 0.15)`}},[n,p]);return t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"12px"},children:Array.from({length:a}).map((b,i)=>t.jsxs("div",{style:{background:u.bgCardLit,border:`1px solid ${u.border}`,borderRadius:"24px",boxShadow:u.cardShadowLit,padding:"16px",display:"flex",alignItems:"center",gap:"12px",position:"relative",overflow:"hidden"},children:[t.jsx("div",{style:{position:"absolute",top:0,left:"25%",right:"25%",height:"1px",background:`linear-gradient(90deg, transparent, ${u.accentLight}4D, transparent)`}}),t.jsx(C,{variant:"circular",width:48,height:48}),t.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",gap:"8px"},children:[t.jsx(C,{width:"70%"}),t.jsx(C,{width:"50%"})]}),t.jsx(C,{variant:"rectangular",width:80,height:32})]},i))})},le=({isOpen:a,onClose:n,impiantoId:p,onDeviceAdded:u,existingMacs:b})=>{const{colors:i}=ie(),[o,j]=_.useState(null),[h,m]=_.useState(""),[f,L]=_.useState(!1),v=async()=>{var c,s;if(!o||!h.trim()){d.error("Inserisci un nome");return}L(!0);try{await y.registerNode(p,o.mac,h.trim(),void 0,o.device_type),d.success("Dispositivo aggiunto!"),u(),S()}catch(D){console.error("Errore registrazione:",D),d.error(((s=(c=D.response)==null?void 0:c.data)==null?void 0:s.error)||"Errore registrazione")}finally{L(!1)}},S=()=>{j(null),m(""),n()},E=c=>{j(c),m(c.device_type==="omniapi_led"?"LED Strip":`Interruttore ${c.mac.slice(-5)}`)};return a?t.jsx(se,{children:t.jsx(g.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:S,style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",backdropFilter:"blur(4px)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"},children:t.jsxs(g.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:c=>c.stopPropagation(),style:{background:i.bgCard,borderRadius:"24px",width:"100%",maxWidth:"400px",maxHeight:"80vh",overflow:"hidden",display:"flex",flexDirection:"column"},children:[t.jsxs("div",{style:{padding:"20px",borderBottom:`1px solid ${i.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[t.jsx("h2",{style:{fontSize:"18px",fontWeight:600,color:i.textPrimary,margin:0},children:o?"Configura Dispositivo":"Aggiungi Dispositivo"}),t.jsx("button",{onClick:S,style:{width:"36px",height:"36px",borderRadius:"12px",background:"rgba(255,255,255,0.1)",border:"none",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(K,{size:20,style:{color:i.textMuted}})})]}),t.jsx("div",{style:{flex:1,overflow:"auto",padding:"16px"},children:o?t.jsxs("div",{children:[t.jsxs("div",{style:{padding:"16px",background:`${i.accent}10`,borderRadius:"16px",marginBottom:"16px",display:"flex",alignItems:"center",gap:"12px"},children:[o.device_type==="omniapi_led"?t.jsx(q,{size:24,style:{color:i.accent}}):t.jsx(J,{size:24,style:{color:i.accent}}),t.jsxs("div",{children:[t.jsx("p",{style:{fontSize:"14px",fontWeight:600,color:i.textPrimary,margin:0},children:o.device_type==="omniapi_led"?"LED Strip":"Relay Node"}),t.jsx("p",{style:{fontSize:"12px",color:i.textMuted,margin:0},children:o.mac})]})]}),t.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"13px",color:i.textSecondary},children:"Nome dispositivo"}),t.jsx("input",{type:"text",value:h,onChange:c=>m(c.target.value),placeholder:"es. Luce Soggiorno",autoFocus:!0,style:{width:"100%",padding:"12px 16px",borderRadius:"12px",background:i.bgSecondary,border:`1px solid ${i.border}`,color:i.textPrimary,fontSize:"15px",outline:"none",boxSizing:"border-box"}}),t.jsxs("div",{style:{display:"flex",gap:"12px",marginTop:"20px"},children:[t.jsx("button",{onClick:()=>j(null),style:{flex:1,padding:"12px",borderRadius:"12px",background:"transparent",border:`1px solid ${i.border}`,color:i.textSecondary,fontSize:"14px",fontWeight:600,cursor:"pointer"},children:"Indietro"}),t.jsx("button",{onClick:v,disabled:f||!h.trim(),style:{flex:1,padding:"12px",borderRadius:"12px",background:i.accent,border:"none",color:"#fff",fontSize:"14px",fontWeight:600,cursor:f?"not-allowed":"pointer",opacity:f||!h.trim()?.6:1},children:f?"Aggiunta...":"Aggiungi"})]})]}):t.jsx(ae,{onDeviceSelected:E,excludeMacs:b,showRefreshButton:!0})})]})})}):null},B=a=>{const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return n?`${parseInt(n[1],16)}, ${parseInt(n[2],16)}, ${parseInt(n[3],16)}`:"106, 212, 160"},I={hidden:{opacity:0,y:30,scale:.95},show:{opacity:1,y:0,scale:1,transition:{duration:.4,ease:"easeOut"}}},T={hidden:{},show:{transition:{staggerChildren:.08}}},je=()=>{const{impiantoCorrente:a}=Q(),{colors:n,modeColors:p}=A(),{dispositivi:u,loading:b,updatePowerState:i,updateLedState:o,fetchDispositivi:j}=te(),{canControl:h,canViewState:m}=ne((a==null?void 0:a.id)||null),[f,L]=_.useState(null),[v,S]=_.useState(!1),[E,c]=_.useState(!1),s=_.useMemo(()=>({...p,accent:n.accent,accentLight:n.accentLight,accentDark:n.accentDark,border:`rgba(${B(n.accent)}, 0.15)`,borderHover:`rgba(${B(n.accent)}, 0.35)`}),[n,p]),D={position:"absolute",top:0,left:"25%",right:"25%",height:"1px",background:`linear-gradient(90deg, transparent, ${s.accentLight}4D, transparent)`,pointerEvents:"none"},M=async e=>{var r,l;if(f!==e.id){L(e.id);try{const x=!e.power_state;e.device_type==="omniapi_led"?(await y.sendLedCommand(e.mac_address,x?"on":"off"),o(e.id,{led_power:x}),i(e.id,x)):e.device_type==="omniapi_node"?(await y.controlNode(e.id,1,x?"on":"off"),i(e.id,x)):(await ee.controlDispositivo(e.id,x?"ON":"OFF"),i(e.id,x))}catch(x){console.error("Errore toggle dispositivo:",x),(l=(r=x.response)==null?void 0:r.data)!=null&&l.blocked?d.error("Bloccato"):d.error("Errore")}finally{L(null)}}},W=async(e,r)=>{if(e.mac_address)try{await y.sendLedCommand(e.mac_address,"set_effect",{effect:r}),o(e.id,{led_effect:r})}catch(l){console.error("Errore effetto LED:",l),d.error("Errore LED")}},P=async(e,r)=>{if(e.mac_address)try{await y.sendLedCommand(e.mac_address,"set_speed",{speed:r}),o(e.id,{led_speed:r})}catch(l){console.error("Errore speed LED:",l),d.error("Errore LED")}},H=async(e,r,l)=>{if(!e.mac_address)return;const x=r.r!==e.led_r||r.g!==e.led_g||r.b!==e.led_b,V=l!==e.led_brightness;try{x&&await y.sendLedCommand(e.mac_address,"set_color",{r:r.r,g:r.g,b:r.b}),V&&await y.sendLedCommand(e.mac_address,"set_brightness",{brightness:l}),o(e.id,{led_r:r.r,led_g:r.g,led_b:r.b,led_brightness:l})}catch(G){console.error("Errore controllo LED:",G),d.error("Errore LED")}},O=async(e,r)=>{if(e.mac_address)try{await y.sendLedCommand(e.mac_address,"set_num_leds",{num_leds:r}),d.success(`LED: ${r}`)}catch(l){console.error("Errore num_leds LED:",l),d.error("Errore LED")}},F=async(e,r)=>{if(e.mac_address)try{await y.sendLedCommand(e.mac_address,"set_custom_effect",{colors:r}),d.success("Custom Rainbow applicato")}catch(l){console.error("Errore custom effect LED:",l),d.error("Errore LED")}},U=async()=>{if(a!=null&&a.id){S(!0);try{await j(a.id),d.success("Aggiornato")}catch{d.error("Errore")}finally{S(!1)}}},w=u.filter(e=>e!=null),k=w.filter(e=>e.device_type==="omniapi_node"||e.device_type==="tasmota"||!e.device_type),$=w.filter(e=>e.device_type==="omniapi_led"),R=w.filter(e=>e.device_type==="sensor");return t.jsxs(re,{children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"20px"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[t.jsxs("div",{children:[t.jsx("h1",{style:{fontSize:"24px",fontWeight:700,color:s.textPrimary,margin:0},children:"Dispositivi"}),t.jsxs("p",{style:{fontSize:"13px",color:s.textMuted,margin:"4px 0 0 0"},children:[w.length," dispositiv",w.length===1?"o":"i"," configurati"]})]}),t.jsxs("div",{style:{display:"flex",gap:"8px"},children:[t.jsx(g.button,{onClick:U,disabled:v,style:{width:"44px",height:"44px",padding:0,borderRadius:"16px",background:s.bgCardLit,border:`1px solid ${s.border}`,cursor:v?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center"},whileHover:{scale:1.05},whileTap:{scale:.95},title:"Aggiorna",children:t.jsx(X,{size:18,style:{color:s.textMuted},className:v?"animate-spin":""})}),t.jsx(g.button,{onClick:()=>c(!0),style:{width:"44px",height:"44px",padding:0,borderRadius:"16px",background:`linear-gradient(135deg, ${s.accent}, ${s.accentDark})`,border:"none",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:`0 4px 20px ${s.accent}50`},whileHover:{scale:1.05,boxShadow:`0 6px 24px ${s.accent}60`},whileTap:{scale:.95},title:"Aggiungi Dispositivo",children:t.jsx(Y,{size:20,style:{color:"#fff",display:"block"}})})]})]}),b?t.jsx(oe,{count:6}):w.length===0?t.jsxs(g.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},style:{background:s.bgCardLit,border:`1px solid ${s.border}`,borderRadius:"28px",boxShadow:s.cardShadowLit,padding:"60px 32px",textAlign:"center",position:"relative",overflow:"hidden"},children:[t.jsx("div",{style:D}),t.jsx(g.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.2,type:"spring"},style:{display:"inline-flex",padding:"20px",background:`${s.accent}15`,borderRadius:"24px",marginBottom:"20px",border:`1px solid ${s.accent}30`},children:t.jsx(Z,{size:48,style:{color:s.textMuted}})}),t.jsx("h3",{style:{fontSize:"22px",fontWeight:600,color:s.textPrimary,margin:"0 0 10px 0"},children:"Nessun dispositivo"}),t.jsx("p",{style:{fontSize:"14px",color:s.textMuted,margin:0,maxWidth:"280px",marginLeft:"auto",marginRight:"auto"},children:"Usa il Wizard nelle Impostazioni per aggiungere nuovi dispositivi"})]}):t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"24px"},children:[$.length>0&&t.jsxs("div",{children:[t.jsxs("h2",{style:{fontSize:"14px",fontWeight:600,color:s.textMuted,marginBottom:"12px",textTransform:"uppercase",letterSpacing:"0.5px"},children:["LED Strip (",$.length,")"]}),t.jsx(g.div,{initial:"hidden",animate:"show",variants:T,style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(140px, 1fr))",gap:"12px"},children:$.map(e=>t.jsx(g.div,{variants:I,children:t.jsx(z,{nome:e.nome,isOn:!!e.led_power||!!e.power_state,isLoading:f===e.id,bloccato:!!e.bloccato,canControl:h,canViewState:m,onToggle:()=>M(e),deviceType:"omniapi_led",variant:"full",ledColor:{r:e.led_r??255,g:e.led_g??255,b:e.led_b??255},ledBrightness:e.led_brightness??255,ledEffect:e.led_effect??0,ledSpeed:e.led_speed??128,onLedChange:(r,l)=>H(e,r,l),onLedEffectChange:r=>W(e,r),onLedSpeedChange:r=>P(e,r),onLedNumLedsChange:r=>O(e,r),onLedCustomEffect:r=>F(e,r)})},e.id))})]}),k.length>0&&t.jsxs("div",{children:[t.jsxs("h2",{style:{fontSize:"14px",fontWeight:600,color:s.textMuted,marginBottom:"12px",textTransform:"uppercase",letterSpacing:"0.5px"},children:["Interruttori (",k.length,")"]}),t.jsx(g.div,{initial:"hidden",animate:"show",variants:T,style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(140px, 1fr))",gap:"12px"},children:k.map(e=>t.jsx(g.div,{variants:I,children:t.jsx(z,{nome:e.nome,isOn:!!e.power_state,isLoading:f===e.id,bloccato:!!e.bloccato,canControl:h,canViewState:m,onToggle:()=>M(e),deviceType:e.device_type||"relay",variant:"full"})},e.id))})]}),R.length>0&&t.jsxs("div",{children:[t.jsxs("h2",{style:{fontSize:"14px",fontWeight:600,color:s.textMuted,marginBottom:"12px",textTransform:"uppercase",letterSpacing:"0.5px"},children:["Sensori (",R.length,")"]}),t.jsx(g.div,{initial:"hidden",animate:"show",variants:T,style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(160px, 1fr))",gap:"12px"},children:R.map(e=>t.jsx(g.div,{variants:I,children:t.jsx(z,{nome:e.nome,isOn:!1,onToggle:()=>{},deviceType:"sensor",variant:"full",canViewState:m,temperature:e.temperature,humidity:e.humidity})},e.id))})]})]})]}),t.jsx(le,{isOpen:E,onClose:()=>c(!1),impiantoId:(a==null?void 0:a.id)||0,onDeviceAdded:()=>{a!=null&&a.id&&j(a.id)},existingMacs:w.map(e=>e.mac_address||"").filter(Boolean)})]})};export{je as Dispositivi};
